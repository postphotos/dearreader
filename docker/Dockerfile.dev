# syntax=docker/dockerfile:1
# This Dockerfile is for DEVELOPMENT and TESTING ONLY.
# It creates images with hot-reloading capabilities.

# ===== Base JS Image =====
FROM node:20-slim AS js-base
WORKDIR /app
# Install Chromium for Puppeteer
RUN apt-get update && apt-get install -y chromium --no-install-recommends && rm -rf /var/lib/apt/lists/*
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# --- JS Dependencies Stage ---
FROM js-base AS js-deps
WORKDIR /app
COPY js/package.json js/package-lock.json* ./
# Install production and dev dependencies so TypeScript and dev tools are available
# in the development image (needed to run tsc inside the container)
RUN npm install --include=dev

# --- JS Dev/Test Source Stage ---
FROM js-deps AS js-dev
WORKDIR /app
COPY js/ ./js/
WORKDIR /app/js

# ===== Base Python Image =====
FROM python:3.9-slim AS python-base
WORKDIR /app
COPY py/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# --- Python Dev Source Stage ---
FROM python-base AS python-dev
WORKDIR /app
COPY py/ ./py/
ENV PYTHONPATH=/app
