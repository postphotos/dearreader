<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DearReader - Web Content Extractor</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="main.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1><i class="fas fa-magic"></i> DearReader</h1>
      <p class="subtitle">Transform any URL into clean, LLM-friendly content with real-time processing</p>
      <div class="formats">
        <span class="format-badge"><i class="fas fa-code"></i> JSON</span>
        <span class="format-badge"><i class="fas fa-file-alt"></i> Markdown</span>
        <span class="format-badge"><i class="fas fa-globe"></i> HTML</span>
        <span class="format-badge"><i class="fas fa-font"></i> Text</span>
        <span class="format-badge"><i class="fas fa-camera"></i> Screenshots</span>
        <span class="format-badge"><i class="fas fa-file-pdf"></i> PDF</span>
      </div>
    </div>

    <div class="examples">
      <h2><i class="fas fa-lightbulb"></i> Try These Examples</h2>
      <div class="example-grid">
        <div class="example-item" onclick="loadExample('https://en.wikipedia.org/wiki/Web_scraping')">
          <div class="example-url"><i class="fas fa-book"></i> Wikipedia Article</div>
          <div class="example-desc">Technical article about web scraping with comprehensive content</div>
        </div>
        <div class="example-item" onclick="loadExample('https://news.ycombinator.com')">
          <div class="example-url"><i class="fas fa-newspaper"></i> Hacker News</div>
          <div class="example-desc">Tech news and discussion site with dynamic content</div>
        </div>
        <div class="example-item" onclick="loadExample('https://github.com/postphotos/dearreader')">
          <div class="example-url"><i class="fab fa-github"></i> GitHub README</div>
          <div class="example-desc">This project's documentation and source code</div>
        </div>
        <div class="example-item" onclick="loadExample('https://httpbin.org/html')">
          <div class="example-url"><i class="fas fa-code"></i> Simple HTML Page</div>
          <div class="example-desc">Clean HTML test page for basic functionality</div>
        </div>
        <div class="example-item" onclick="loadExample('https://arxiv.org/abs/2301.00001')">
          <div class="example-url"><i class="fas fa-graduation-cap"></i> Research Paper</div>
          <div class="example-desc">Academic paper with complex formatting and references</div>
        </div>
        <div class="example-item" onclick="loadExample('https://www.nytimes.com')">
          <div class="example-url"><i class="fas fa-newspaper"></i> News Website</div>
          <div class="example-desc">Major news site with rich media content</div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="card">
        <h2><i class="fas fa-rocket"></i> Extract Web Content</h2>
        <form id="extractForm">
          <div class="form-group">
            <label for="url"><i class="fas fa-link"></i> Website URL</label>
            <input type="url" id="url" placeholder="https://example.com" required>
          </div>

          <div class="form-group">
            <label for="format"><i class="fas fa-cogs"></i> Output Format</label>
            <select id="format">
              <option value="json">üìÑ JSON (Full metadata & links)</option>
              <option value="markdown">üìù Markdown (Clean text)</option>
              <option value="html">üåê HTML (Cleaned HTML)</option>
              <option value="text">üìñ Plain Text</option>
              <option value="screenshot">üì∏ Screenshot (PNG)</option>
              <option value="pdf">üìï PDF Content</option>
            </select>
          </div>

          <!-- Screenshot Options (shown when screenshot is selected) -->
          <div id="screenshotOptions" class="form-group hidden">
            <label for="viewport"><i class="fas fa-desktop"></i> Screenshot Size</label>
            <select id="viewport">
              <option value="desktop">üíª Desktop (1280x1024)</option>
              <option value="tablet">üì± Tablet (768x1024)</option>
              <option value="mobile">üì± Mobile (375x667)</option>
              <option value="fullpage">üìÑ Full Page</option>
            </select>
          </div>

          <!-- PDF Options (shown when PDF is selected) -->
          <div id="pdfOptions" class="form-group hidden">
            <label for="pdfAction"><i class="fas fa-file-pdf"></i> PDF Action</label>
            <select id="pdfAction">
              <option value="extract">üìñ Extract Text Content</option>
              <option value="download">‚¨áÔ∏è Download PDF File</option>
              <option value="screenshot">üì∏ Screenshot of PDF</option>
            </select>
          </div>

          <button type="submit" class="btn" id="extractBtn">
            <i class="fas fa-play"></i>
            Extract Content
          </button>
        </form>

        <div id="loading" class="loading">
          <i class="fas fa-spinner"></i>
          <div>Extracting content...</div>
        </div>

        <div id="result" class="result">
          <div class="result-header">
            <div class="result-title">
              <i class="fas fa-check-circle"></i>
              Extraction Result
            </div>
            <button class="copy-btn" onclick="copyResult()">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
          <div id="resultContent"></div>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-chart-line"></i> API Status</h2>

        <div class="api-status">
          <div class="status-header" id="apiStatusHeader">
            <i class="fas fa-circle"></i>
            Checking API status...
          </div>
          <div class="status-details" id="apiStatusDetails"></div>
        </div>

        <div class="queue-info hidden" id="queueInfo">
          <div class="queue-item">
            <span class="queue-value" id="totalRequests">-</span>
            <span class="queue-label">Total</span>
          </div>
          <div class="queue-item">
            <span class="queue-value" id="activeRequests">-</span>
            <span class="queue-label">Active</span>
          </div>
          <div class="queue-item">
            <span class="queue-value" id="pendingRequests">-</span>
            <span class="queue-label">Pending</span>
          </div>
          <div class="queue-item">
            <span class="queue-value" id="completedRequests">-</span>
            <span class="queue-label">Completed</span>
          </div>
        </div>

        <div class="links">
          <a href="/queue-ui" class="link-btn">
            <i class="fas fa-tasks"></i>
            Queue Monitor
          </a>
          <a href="https://github.com/postphotos/dearreader" target="_blank" rel="noopener" class="link-btn">
            <i class="fab fa-github"></i>
            View Source
          </a>
          <a href="/api-docs" class="link-btn">
            <i class="fas fa-book"></i>
            API Docs
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="status" class="status"></div>

  <script>
    // Load example URL
    function loadExample(url) {
      document.getElementById('url').value = url;
      showStatus('Example URL loaded!', 'success');
    }

    // Copy result to clipboard
    async function copyResult() {
      const resultContent = document.getElementById('resultContent');
      try {
        await navigator.clipboard.writeText(resultContent.textContent || resultContent.innerText);
        showStatus('Copied to clipboard!', 'success');
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = resultContent.textContent || resultContent.innerText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showStatus('Copied to clipboard!', 'success');
      }
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';

      setTimeout(() => {
        status.style.display = 'none';
      }, 3000);
    }

    // Check API status on page load
    async function checkAPIStatus() {
      try {
        const response = await fetch('/queue');
        const data = await response.json();

        const statusHeader = document.getElementById('apiStatusHeader');
        const statusDetails = document.getElementById('apiStatusDetails');

        statusHeader.innerHTML = `
          <i class="fas fa-circle" style="color: #10b981;"></i>
          <span class="status-online">API Online</span>
        `;

        statusDetails.innerHTML = `
          <div><strong>Status:</strong> ${data.status}</div>
          <div><strong>Uptime:</strong> ${Math.round(data.uptime / 60)} minutes</div>
          <div><strong>Memory:</strong> ${Math.round(data.memory_usage.heapUsed / 1024 / 1024)} MB</div>
        `;

        // Show queue info
        document.getElementById('queueInfo').classList.remove('hidden');
        document.getElementById('totalRequests').textContent = data.total_requests;
        document.getElementById('activeRequests').textContent = data.active_requests;
        document.getElementById('pendingRequests').textContent = data.pending_requests;
        document.getElementById('completedRequests').textContent = data.completed_requests;

      } catch (error) {
        console.error('Error checking API status:', error);
        const statusHeader = document.getElementById('apiStatusHeader');
        const statusDetails = document.getElementById('apiStatusDetails');

        statusHeader.innerHTML = `
          <i class="fas fa-circle" style="color: #ef4444;"></i>
          <span class="status-offline">API Offline</span>
        `;

        statusDetails.innerHTML = `
          <div>Unable to connect to API server</div>
          <div style="margin-top: 8px; font-size: 13px; color: #6b7280;">
            Make sure the server is running on port 3000
          </div>
        `;

        document.getElementById('queueInfo').classList.add('hidden');
      }
    }

    // Handle format change to show/hide options
    document.getElementById('format').addEventListener('change', function(e) {
      const format = e.target.value;
      const screenshotOptions = document.getElementById('screenshotOptions');
      const pdfOptions = document.getElementById('pdfOptions');

      if (format === 'screenshot') {
        screenshotOptions.classList.remove('hidden');
        pdfOptions.classList.add('hidden');
      } else if (format === 'pdf') {
        screenshotOptions.classList.add('hidden');
        pdfOptions.classList.remove('hidden');
      } else {
        screenshotOptions.classList.add('hidden');
        pdfOptions.classList.add('hidden');
      }
    });

    // Handle form submission
    document.getElementById('extractForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const url = document.getElementById('url').value;
      const format = document.getElementById('format').value;
      const viewport = document.getElementById('viewport')?.value || 'desktop';
      const pdfAction = document.getElementById('pdfAction')?.value || 'extract';
      const extractBtn = document.getElementById('extractBtn');

      if (!url) {
        showStatus('Please enter a URL', 'error');
        return;
      }

      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      const resultContent = document.getElementById('resultContent');

      // Update UI for loading state
      extractBtn.disabled = true;
      extractBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting...';
      loading.style.display = 'block';
      result.style.display = 'none';
      result.className = 'result';

      try {
        let headers = {};
        let endpoint = `/${encodeURIComponent(url)}`;

        // Add format-specific headers
        switch (format) {
          case 'json':
            headers['Accept'] = 'application/json';
            break;
          case 'markdown':
            headers['Accept'] = 'text/plain';
            break;
          case 'html':
            headers['X-Respond-With'] = 'html';
            break;
          case 'text':
            headers['X-Respond-With'] = 'text';
            break;
          case 'screenshot':
            headers['X-Respond-With'] = 'screenshot';
            // Add viewport options
            if (viewport === 'desktop') {
              headers['X-Viewport-Width'] = '1280';
              headers['X-Viewport-Height'] = '1024';
            } else if (viewport === 'tablet') {
              headers['X-Viewport-Width'] = '768';
              headers['X-Viewport-Height'] = '1024';
            } else if (viewport === 'mobile') {
              headers['X-Viewport-Width'] = '375';
              headers['X-Viewport-Height'] = '667';
            } else if (viewport === 'fullpage') {
              headers['X-Full-Page'] = 'true';
            }
            break;
          case 'pdf':
            headers['X-Respond-With'] = 'pdf';
            headers['X-PDF-Action'] = pdfAction;
            break;
        }

        const response = await fetch(endpoint, { headers });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        let content;
        const contentType = response.headers.get('content-type');

        if (contentType && contentType.includes('application/json')) {
          const jsonData = await response.json();
          content = JSON.stringify(jsonData, null, 2);
          result.classList.add('success');
        } else if (format === 'screenshot' || (format === 'pdf' && pdfAction === 'screenshot')) {
          // Handle binary content or URLs
          const textContent = await response.text();
          if (textContent.startsWith('http')) {
            content = `üì∏ Screenshot captured successfully!\n\nüîó <a href="${textContent}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">üìé Open Screenshot</a>\n\nüí° Right-click the link above and select "Save link as..." to download the image.`;
          } else {
            content = textContent;
          }
          result.classList.add('success');
        } else if (format === 'pdf' && pdfAction === 'download') {
          // Handle PDF download
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          content = `üìï PDF downloaded successfully!\n\nüîó <a href="${url}" download="document.pdf" style="color: #667eea; text-decoration: none; font-weight: bold;">üìé Download PDF</a>\n\nüí° Click the link above to download the PDF file.`;
          result.classList.add('success');
        } else if (format === 'pdf' && pdfAction === 'extract') {
          // Handle PDF text extraction
          content = await response.text();
          result.classList.add('success');
        } else {
          content = await response.text();
          result.classList.add('success');
        }

        resultContent.innerHTML = content;
        result.style.display = 'block';
        showStatus('Content extracted successfully!', 'success');

      } catch (error) {
        console.error('Error during extraction:', error);
        resultContent.textContent = `‚ùå Error: ${error.message}`;
        result.className = 'result error';
        result.style.display = 'block';
        showStatus('Extraction failed', 'error');
      } finally {
        loading.style.display = 'none';
        extractBtn.disabled = false;
        extractBtn.innerHTML = '<i class="fas fa-play"></i> Extract Content';
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkAPIStatus();
      // Refresh API status every 30 seconds
      setInterval(checkAPIStatus, 30000);
    });
  </script>
  <script src="main.js"></script>
  <script src="app.js"></script>
</body>
</html>
